name: Deploy Frontend to Vercel

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'frontend/frontend/**'
      - '.github/workflows/deploy_frontend.yml'

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend/frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          # Usamos stable para estar siempre a la 煤ltima, o puedes fijar una versi贸n espec铆fica
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Update Version (Auto-Bump)
        run: |
          # Extraer la versi贸n base (ej: 1.0.0) del pubspec.yaml
          BASE_VERSION=$(grep '^version: ' pubspec.yaml | sed 's/version: //g' | cut -d'+' -f1)
          NEW_VERSION="${BASE_VERSION}+${{ github.run_number }}"
          
          # Crear nueva versi贸n usando el n煤mero de ejecuci贸n de GitHub como build number
          # Esto garantiza que siempre sea ascendente y 煤nico
          echo " Bumping version to $NEW_VERSION"
          
          # Reemplazar en el archivo
          sed -i "s/^version: .*/version: $NEW_VERSION/" pubspec.yaml

      - name: Build Web
        run: flutter build web --release --dart-define=FLUTTER_WEB_RENDERER=html --no-source-maps

      - name: Copy Vercel Config
        # Copiamos la configuraci贸n para asegurar el no-cache en los archivos cr铆ticos
        run: cp vercel.json build/web/vercel.json

      - name: Deploy to Vercel
        # Usamos npx vercel para no depender de acciones de terceros
        # --prod: Despliegue a producci贸n
        # --yes: Confirmar autom谩ticamente
        # --token: Usamos el secreto configurado en GitHub
        run: npx vercel deploy build/web --prod --token ${{ secrets.VERCEL_TOKEN }} --yes
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
